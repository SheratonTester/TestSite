<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RPM & Mechanical PM – Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #e5f0ff;
      --card: #ffffff;
      --accent: #2563eb;
      --accent-soft: rgba(37,99,235,0.08);
      --text: #0f172a;
      --muted: #6b7280;
      --danger: #e11d48;
      --success: #16a34a;
      --border: #d1d5db;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e5f0ff, #f9fafb);
      color: var(--text);
      padding: 12px;
    }
    h1,h2,h3,h4 { margin: 0 0 8px; }
    h1 { font-size: 1.25rem; }
    h2 { font-size: 1.1rem; }
    h3 { font-size: 1rem; }
    p { margin: 4px 0; }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto 32px;
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 12px;
      border: 1px solid var(--border);
      margin-bottom: 12px;
      box-shadow: 0 12px 30px rgba(15,23,42,0.12);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148,163,184,0.6);
      color: var(--muted);
      background: #f9fafb;
      white-space: nowrap;
    }
    .pill.accent {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }
    .pill.success {
      border-color: var(--success);
      color: var(--success);
      background: rgba(34,197,94,0.12);
    }
    .pill.danger {
      border-color: var(--danger);
      color: rgba(190,24,93,1);
      background: rgba(248,113,113,0.12);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .row > * {
      flex: 1 1 120px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }
    .field label {
      font-size: 0.75rem;
      color: var(--muted);
    }

    input, select, textarea {
      font: inherit;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      padding: 6px 8px;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
    }

    button {
      font: inherit;
      cursor: pointer;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #2563eb, #22c55e);
      color: #ffffff;
      font-weight: 600;
      font-size: 0.8rem;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    button.secondary {
      background: #f9fafb;
      color: var(--muted);
      border: 1px solid var(--border);
    }
    button.danger {
      background: linear-gradient(135deg, #fb7185, #e11d48);
      color: #fef2f2;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }
    .metric-card {
      background: #f9fafb;
      border-radius: 10px;
      padding: 8px;
      border: 1px solid var(--border);
    }
    .metric-label {
      font-size: 0.7rem;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .metric-value {
      font-size: 0.95rem;
      font-weight: 600;
    }
    .metric-note {
      font-size: 0.65rem;
      color: var(--muted);
    }

    .progress-wrapper {
      display: flex;
      gap: 8px;
      align-items: flex-end;
      margin-top: 8px;
    }
    .progress-bar-outer {
      flex: 0 0 32px;
      height: 120px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #eef2ff;
      display: flex;
      align-items: flex-end;
      overflow: hidden;
    }
    .progress-bar-inner {
      width: 100%;
      background: linear-gradient(180deg, #22c55e, #16a34a);
      transition: height 0.4s ease;
      height: 0%;
    }
    .progress-meta {
      font-size: 0.7rem;
      color: var(--muted);
    }

    @media (min-width: 900px) {
      .layout-main {
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 12px;
        align-items: flex-start;
      }
    }

    /* Room / unit map */
    .room-map-scroll {
      max-height: 240px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .room-map-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(52px, 1fr));
      gap: 4px;
      margin-top: 4px;
    }
    .room-chip {
      border-radius: 10px;
      padding: 4px 0;
      font-size: 0.7rem;
      text-align: center;
      border: 1px solid var(--border);
      cursor: pointer;
      background: #ffffff;
      color: var(--muted);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease;
    }
    .room-chip.done {
      background: #dcfce7;
      color: var(--success);
      border-color: #16a34a;
      font-weight: 600;
    }
    .room-chip.in-progress {
      background: #dbeafe;
      color: #1d4ed8;
      border-color: #2563eb;
      font-weight: 600;
    }
    .room-chip.todo {
      background: #f9fafb;
      color: var(--muted);
    }
    .room-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(15,23,42,0.3);
    }
    .room-legend {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      font-size: 0.65rem;
      color: var(--muted);
      flex-wrap: wrap;
    }
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 3px;
    }
    .legend-done { background: #16a34a; }
    .legend-progress { background: #2563eb; }
    .legend-todo { background: #9ca3af; }

    /* Sort buttons */
    .sort-toggle {
      margin-bottom: 0;
      min-width: 180px;
    }
    .sort-buttons {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .sort-btn {
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: var(--muted);
      cursor: pointer;
    }
    .sort-btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
      font-weight: 600;
    }

    /* Mode toggle */
    .mode-toggle {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }
    .mode-btn {
      font: inherit;
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: var(--muted);
      padding: 4px 10px;
      font-size: 0.75rem;
    }
    .mode-btn.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent);
      font-weight: 600;
    }
    .mode-btn:hover {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent);
    }

    /* Active sessions */
    .timer-display {
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 1.05rem;
      letter-spacing: 0.06em;
    }
    .badge-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 0.7rem;
      margin-top: 4px;
    }

    /* Checklist */
    .checklist {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .question-block {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px;
      background: #f9fafb;
    }
    .question-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: baseline;
      flex-wrap: wrap;
    }
    .question-text {
      font-size: 0.8rem;
    }
    .question-section {
      font-size: 0.65rem;
      color: var(--muted);
    }
    .answer-buttons {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .answer-btn {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--muted);
      cursor: pointer;
    }
    .answer-btn.selected.yes {
      background: #dcfce7;
      border-color: #16a34a;
      color: var(--success);
      font-weight: 600;
    }
    .answer-btn.selected.no {
      background: #fee2e2;
      border-color: #e11d48;
      color: var(--danger);
      font-weight: 600;
    }
    .answer-btn.selected.na {
      background: #e5e7eb;
      border-color: #9ca3af;
      color: var(--muted);
      font-weight: 600;
    }
    .question-meta {
      font-size: 0.65rem;
      color: var(--muted);
      margin-top: 3px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .question-meta span {
      display: inline-block;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .table-scroll {
      max-height: 220px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }
    .table th, .table td {
      padding: 6px 4px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    .table th {
      font-weight: 600;
      color: var(--muted);
      font-size: 0.7rem;
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }

    .bar-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .bar-label {
      flex: 0 0 90px;
      font-size: 0.7rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bar-track {
      flex: 1;
      height: 8px;
      border-radius: 999px;
      background: #eef2ff;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #2563eb, #22c55e);
      transition: width 0.4s ease;
    }
    .bar-value {
      font-size: 0.7rem;
      color: var(--muted);
      flex: 0 0 40px;
      text-align: right;
    }

    .inspect-box {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px;
      margin-bottom: 4px;
      background: #f9fafb;
    }

    .admin-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }
    .admin-tab-btn {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: var(--muted);
      cursor: pointer;
    }
    .admin-tab-btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
      font-weight: 600;
    }
    .admin-list {
      max-height: 220px;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 0.75rem;
    }
    .admin-list-item {
      padding: 4px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .admin-list-main {
      flex: 1;
    }
    .admin-title {
      font-weight: 600;
      font-size: 0.8rem;
    }
    .admin-sub {
      font-size: 0.68rem;
      color: var(--muted);
    }
    .admin-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .admin-footer-actions {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .goal-text {
      font-size: 0.8rem;
      color: var(--text);
      line-height: 1.4;
    }
    .goal-text ul {
      padding-left: 20px;
      margin: 6px 0;
    }
    .goal-note {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 4px;
    }
  </style>
</head>
<body>
<div class="app-shell">

  <!-- HEADER + MODE BUTTONS -->
  <div class="card">
    <div class="card-header">
      <div>
        <h1>RPM &amp; Mechanical PM – Demo</h1>
        <p style="font-size:0.75rem;color:var(--muted);">
          Sheraton Fallsview · Preventive maintenance workflow demo (rooms + mechanical).
        </p>
      </div>
      <div style="text-align:right;">
        <div class="pill accent">Demo login: Alex Carter · Team Lead</div>
        <div class="pill" style="margin-top:4px;">Designed &amp; managed by Gerry Dorion</div>
      </div>
    </div>
    <div class="mode-toggle">
      <span style="font-size:0.75rem;color:var(--muted);margin-right:4px;">View mode:</span>
      <button type="button" class="mode-btn active" data-mode="RPM">
        RPM (Guest rooms)
      </button>
      <button type="button" class="mode-btn" data-mode="PM">
        PM (Mechanical)
      </button>
    </div>
  </div>

  <!-- RPM SECTION (ROOMS) -->
  <div id="rpmSection">
    <div class="card">
      <div class="card-header">
        <div>
          <h2>RPM – Rooms Overview (Demo)</h2>
          <p style="font-size:0.75rem;color:var(--muted);">
            Demo of guest room RPM progress, engineer scores, and ranking.
          </p>
        </div>
      </div>

      <div class="metrics">
        <div class="metric-card">
          <div class="metric-label">RPM period progress (demo data)</div>
          <div class="row" style="gap:6px;margin-bottom:4px;">
            <div class="field" style="margin-bottom:0;">
              <label>Year</label>
              <select id="yearSelect">
                <option value="2025" selected>2025</option>
                <option value="2024">2024</option>
              </select>
            </div>
            <div class="field" style="margin-bottom:0;">
              <label>Period</label>
              <select id="periodSelect">
                <option value="1" selected>Period 1</option>
                <option value="2">Period 2</option>
                <option value="3">Period 3</option>
              </select>
            </div>
          </div>
          <div class="progress-wrapper">
            <div class="progress-bar-outer">
              <div id="periodProgressBar" class="progress-bar-inner"></div>
            </div>
            <div class="progress-meta">
              <div id="periodProgressLabel">0 / 0 demo rooms completed</div>
              <div id="periodProgressPct">0% of target</div>
              <div style="margin-top:4px;font-size:0.65rem;">
                Demo target: every room completed once per period.
              </div>
            </div>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-label">RPM overview (demo)</div>
          <div class="metric-value" id="summaryCompleted">0 RPMs completed</div>
          <div class="metric-note" id="summaryTarget">Target: 0 · Δ 0</div>
          <div class="metric-note" id="summaryAvgTime">Avg time: 0 min</div>
        </div>

        <div class="metric-card">
          <div class="metric-label">Top engineer – RPM</div>
          <div class="metric-value" id="topEngineerName">–</div>
          <div class="metric-note" id="topEngineerScore">Avg score: –</div>
        </div>
      </div>
    </div>

    <div class="layout-main">
      <!-- LEFT: Room map + active RPM + checklist -->
      <div>
        <div class="card">
          <div class="card-header">
            <div>
              <h2>Room Map (RPM demo)</h2>
              <p style="font-size:0.75rem;color:var(--muted);">
                Tap a room to pre-fill the RPM form.
              </p>
            </div>
            <div class="field sort-toggle">
              <label>Sort rooms</label>
              <div class="sort-buttons">
                <button type="button" class="sort-btn active" data-sort="furthest">Furthest last done</button>
                <button type="button" class="sort-btn" data-sort="room">Room number</button>
              </div>
            </div>
          </div>
          <div class="room-map-scroll">
            <div class="room-map-grid" id="roomMap"></div>
          </div>
          <div class="room-legend">
            <span><span class="legend-dot legend-done"></span>Completed (this period)</span>
            <span><span class="legend-dot legend-progress"></span>Current active room</span>
            <span><span class="legend-dot legend-todo"></span>Not yet done</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Active RPM Session (Engineer demo)</h2>
            <span class="pill accent" id="activeStatusPill">No active room</span>
          </div>
          <div class="row">
            <div class="field">
              <label>Room number</label>
              <input id="roomInput" type="text" inputmode="numeric" placeholder="e.g. 258">
            </div>
            <div class="field">
              <label>Timer</label>
              <div class="timer-display" id="timerDisplay">00:00</div>
              <div class="badge-row" id="timerBadges"></div>
            </div>
          </div>
          <div id="lastPmInfo" style="margin-top:6px;font-size:0.75rem;color:var(--muted);">
            Click a room above to view when it was last done, by who, and their score (demo).
          </div>
          <div class="row" style="margin-top:8px;margin-bottom:8px;">
            <button id="startBtn">Start RPM</button>
            <button id="pauseBtn" class="secondary" disabled>Pause</button>
            <button id="resumeBtn" class="secondary" disabled>Resume</button>
            <button id="completeBtn" disabled>Complete</button>
            <button id="cancelBtn" class="danger" disabled>Cancel</button>
          </div>
          <div style="font-size:0.7rem;color:var(--muted);">
            This RPM demo keeps everything in your browser only. No data is sent anywhere.
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>RPM Checklist (Demo)</h2>
            <span class="pill">All questions must be answered to complete.</span>
          </div>
          <div class="checklist" id="checklistContainer"></div>
          <div class="field">
            <label>Overall room notes</label>
            <textarea id="overallNotes" placeholder="Optional notes for this room"></textarea>
          </div>
          <button id="completeBtnBottom" style="margin-top:6px;">Complete RPM (same as above)</button>
        </div>
      </div>

      <!-- RIGHT: Completed RPMs + inspection + ranking + admin + goal -->
      <div>
        <div class="card">
          <div class="card-header">
            <h2>Completed RPMs (Demo)</h2>
            <span class="pill">Tap "Inspect" to open review.</span>
          </div>
          <div class="table-scroll">
            <table class="table" id="sessionsTable">
              <thead>
              <tr>
                <th>Room</th>
                <th>Engineer</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Review</th>
                <th></th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Inspection (Team Lead demo)</h2>
            <span class="pill success" id="inspectHeaderLabel">Select a completed RPM</span>
          </div>
          <div id="inspectionPanel" style="font-size:0.75rem;color:var(--muted);">
            No RPM selected yet. Choose a row from "Completed RPMs".
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Engineer Rankings – RPM (Demo)</h2>
            <span class="pill">Based on inspected RPM scores.</span>
          </div>
          <div id="rankingBars"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Admin Demo</h2>
            <span class="pill">Edit demo engineers, rooms, questions</span>
          </div>
          <div class="admin-tabs">
            <button type="button" class="admin-tab-btn active" data-tab="engineers">Engineers</button>
            <button type="button" class="admin-tab-btn" data-tab="rooms">Rooms</button>
            <button type="button" class="admin-tab-btn" data-tab="questions">RPM questions</button>
          </div>
          <div id="adminContent"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Goal of this System (Demo)</h2>
            <span class="pill">Prototype only – not final look</span>
          </div>
          <div class="goal-text">
            <p>
              This demo is the first step toward a full maintenance platform for our hotels.
              The long-term goal is:
            </p>
            <ul>
              <li>To run <strong>RPM (room preventive maintenance)</strong> and <strong>Mechanical PM</strong> on separate pages in one system.</li>
              <li>To <strong>track project time and cost</strong> based on each employee’s hours.</li>
              <li>To let <strong>each property see only its own data</strong>, while management can see performance for <strong>all properties</strong> in one place.</li>
              <li>To show <strong>performance dashboards</strong> per property: average RPM time, inspection scores, open and completed projects, and trends.</li>
              <li>To <strong>track FTE automatically</strong> based on hours worked and workload across all properties.</li>
              <li>To handle <strong>item ordering, meter tracking, and other maintenance checklists</strong> inside this one system.</li>
            </ul>
            <p class="goal-note">
              Final version will include multi-property views for management, plus RPM, mechanical PM, projects, and labour all in one place.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MECHANICAL PM SECTION -->
  <div id="mechSection">
    <div class="card">
      <div class="card-header">
        <div>
          <h2>Mechanical PM – Overview (Demo)</h2>
          <p style="font-size:0.75rem;color:var(--muted);">
            Demo of boiler, pump, chiller and other mechanical PM inspections.
          </p>
        </div>
      </div>

      <div class="metrics">
        <div class="metric-card">
          <div class="metric-label">Mechanical period progress (demo data)</div>
          <div class="row" style="gap:6px;margin-bottom:4px;">
            <div class="field" style="margin-bottom:0;">
              <label>Year</label>
              <select id="mechYearSelect">
                <option value="2025" selected>2025</option>
                <option value="2024">2024</option>
              </select>
            </div>
            <div class="field" style="margin-bottom:0;">
              <label>Period</label>
              <select id="mechPeriodSelect">
                <option value="1" selected>Period 1</option>
                <option value="2">Period 2</option>
                <option value="3">Period 3</option>
              </select>
            </div>
          </div>
          <div class="progress-wrapper">
            <div class="progress-bar-outer">
              <div id="mechPeriodProgressBar" class="progress-bar-inner"></div>
            </div>
            <div class="progress-meta">
              <div id="mechPeriodProgressLabel">0 / 0 units completed</div>
              <div id="mechPeriodProgressPct">0% of target</div>
              <div style="margin-top:4px;font-size:0.65rem;">
                Demo target: each mechanical unit serviced once per period.
              </div>
            </div>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-label">Mechanical overview (demo)</div>
          <div class="metric-value" id="mechSummaryCompleted">0 PMs completed</div>
          <div class="metric-note" id="mechSummaryTarget">Target: 0 · Δ 0</div>
          <div class="metric-note" id="mechSummaryAvgTime">Avg time: 0 min</div>
        </div>

        <div class="metric-card">
          <div class="metric-label">Top engineer – Mechanical PM</div>
          <div class="metric-value" id="mechTopEngineerName">–</div>
          <div class="metric-note" id="mechTopEngineerScore">Avg score: –</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Mechanical Units (Demo)</h3>
        <span class="pill">Random hotel equipment list.</span>
      </div>
      <div class="room-map-scroll">
        <div class="room-map-grid" id="mechUnitGrid"></div>
      </div>
      <div class="room-legend">
        <span><span class="legend-dot legend-done"></span>Unit completed (this period)</span>
        <span><span class="legend-dot legend-progress"></span>Current active unit</span>
        <span><span class="legend-dot legend-todo"></span>Not yet done</span>
      </div>
    </div>

    <!-- ACTIVE MECHANICAL PM SESSION -->
    <div class="card">
      <div class="card-header">
        <h3>Active Mechanical PM Session (Engineer demo)</h3>
        <span class="pill accent" id="mechActiveStatusPill">No active unit</span>
      </div>
      <div class="row">
        <div class="field">
          <label>Mechanical unit</label>
          <select id="mechUnitSelect">
            <option value="">Select unit…</option>
          </select>
        </div>
        <div class="field">
          <label>Timer</label>
          <div class="timer-display" id="mechTimerDisplay">00:00</div>
          <div class="badge-row" id="mechTimerBadges"></div>
        </div>
      </div>
      <div id="mechLastPmInfo" style="margin-top:6px;font-size:0.75rem;color:var(--muted);">
        Select a unit above to view when it was last done, by who, and the score (demo).
      </div>
      <div class="row" style="margin-top:8px;margin-bottom:8px;">
        <button id="mechStartBtn">Start PM</button>
        <button id="mechPauseBtn" class="secondary" disabled>Pause</button>
        <button id="mechResumeBtn" class="secondary" disabled>Resume</button>
        <button id="mechCompleteBtn" disabled>Complete</button>
        <button id="mechCancelBtn" class="danger" disabled>Cancel</button>
      </div>
      <div style="font-size:0.7rem;color:var(--muted);">
        This mechanical PM demo also stays in your browser only. No data is sent anywhere.
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Mechanical PM Checklist (Demo)</h3>
        <span class="pill">All questions must be answered to complete.</span>
      </div>
      <div class="checklist" id="mechChecklistContainer"></div>
      <div class="field">
        <label>Overall unit notes</label>
        <textarea id="mechOverallNotes" placeholder="Optional notes for this mechanical unit"></textarea>
      </div>
      <button id="mechCompleteBtnBottom" style="margin-top:6px;">
        Complete mechanical PM (same as above)
      </button>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Completed Mechanical PMs (Demo)</h3>
        <span class="pill">Random inspections per unit + ones you add.</span>
      </div>
      <div class="table-scroll">
        <table class="table" id="mechSessionsTable">
          <thead>
          <tr>
            <th>Unit</th>
            <th>Engineer</th>
            <th>Duration</th>
            <th>Status</th>
            <th>Review</th>
            <th></th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="margin-top:8px;">
        <h3 style="margin-bottom:4px;">Mechanical inspection details</h3>
        <div id="mechInspectionPanel" style="font-size:0.75rem;color:var(--muted);">
          Select a row above to see details.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Engineer Rankings – Mechanical PM (Demo)</h3>
        <span class="pill">Based on mechanical PM review scores.</span>
      </div>
      <div id="mechRankingBars"></div>
    </div>
  </div>
</div>

<script>
  // --- RPM demo data (rooms) ---

  let demoRooms = Array.from(new Set(`
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
338
339
340
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
389
390
391
392
393
394
395
396
397
398
399
438
439
440
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
489
490
491
492
493
494
495
496
497
498
499
538
539
540
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
589
590
591
592
593
594
595
596
597
598
599
638
639
640
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
689
690
691
692
693
694
695
696
697
698
699
738
739
740
757
758
759
760
761
762
763
764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
789
790
791
792
793
794
795
796
797
798
799
838
839
840
857
858
859
860
861
862
863
864
865
866
867
868
869
870
871
872
873
874
875
876
877
878
889
890
891
892
893
894
895
896
897
898
899
938
939
940
957
958
959
960
961
962
963
964
965
966
967
968
969
970
971
972
973
974
975
976
977
978
989
990
991
992
993
994
995
996
997
998
999
1038
1039
1040
1057
1058
1059
1060
1061
1062
1063
1064
1065
1066
1067
1068
1069
1070
1071
1072
1073
1074
1075
1076
1077
1078
1089
1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1138
1139
1140
1157
1158
1159
1160
1161
1162
1163
1164
1165
1166
1167
1168
1169
1170
1171
1172
1173
1174
1175
1176
1177
1178
1189
1190
1191
1192
1193
1194
1195
1196
1197
1198
1199
1238
1239
1240
1257
1258
1259
1260
1261
1262
1263
1264
1265
1266
1267
1268
1269
1270
1271
1272
1273
1274
1275
1276
1277
1278
1289
1290
1291
1292
1293
1294
1295
1296
1297
1298
1299
1457
1458
1459
1460
1461
1462
1463
1464
1465
1466
1467
1468
1469
1470
1471
1557
1558
1559
1560
1561
1562
1563
1564
1565
1566
1567
1568
1569
1570
1571
1572
1573
1574
1575
1576
1638
1639
1640
1657
1658
1659
1660
1661
1662
1663
1664
1665
1666
1667
1668
1669
1669
1670
1671
1672
1673
1674
1675
1676
1677
1678
1689
1690
1691
1692
1693
1694
1695
1696
1697
1698
1699
1738
1739
1740
1757
1758
1759
1760
1761
1762
1763
1764
1765
1766
1767
1768
1769
1770
1771
1772
1773
1774
1775
1776
1777
1778
1789
1790
1791
1792
1793
1794
1795
1796
1797
1798
1799
1838
1839
1840
1857
1858
1859
1860
1861
1862
1863
1864
1865
1866
1867
1868
1869
1870
1871
1872
1873
1874
1875
1876
1877
1878
1889
1890
1891
1892
1893
1894
1895
1896
1897
1898
1899
1938
1939
1940
1957
1958
1959
1960
1961
1962
1963
1964
1965
1966
1967
1968
1969
1970
1971
1972
1973
1974
1975
1976
1977
1978
1989
1990
1991
1992
1993
1994
1995
1996
1997
1998
1999
2038
2039
2040
2057
2058
2059
2060
2061
2062
2063
2064
2065
2065
2066
2067
2068
2069
2070
2071
2072
2073
2074
2075
2076
2077
2078
2089
2090
2091
2092
2093
2094
2095
2096
2097
2098
2099
2138
2139
2140
2157
2158
2159
2160
2161
2162
2163
2164
2165
2166
2167
2168
2169
2170
2171
2172
2173
2174
2175
2176
2177
2178
2189
2190
2191
2192
2193
2194
2195
2196
2197
2198
2199
2238
2239
2240
2257
2258
2259
2260
2261
2262
2263
2264
2265
2266
2267
2268
2269
2270
2271
2272
2273
2274
2275
2276
2277
2278
2289
2290
2291
2292
2293
2294
2295
2296
2297
2298
2299
`.trim().split(/\s+/)));

  let demoEngineers = [
    { code: "ENG001", name: "Alex Carter", role: "team_lead" },
    { code: "ENG002", name: "Jordan Lee", role: "engineer" },
    { code: "ENG003", name: "Samir Patel", role: "engineer" }
  ];

  const questions = [
    { id: 1, section: "Bathroom", text: "Showers/tubs drain properly (no standing water)." },
    { id: 2, section: "Bathroom", text: "No water escaping onto floor during shower." },
    { id: 3, section: "Bathroom", text: "Bathroom fan runs and pulls air (tissue test at grille)." },
    { id: 4, section: "Bathroom", text: "Hot water reaches taps quickly and stays stable." },
    { id: 5, section: "Bathroom", text: "Sink drains freely and can hold water when needed." },
    { id: 6, section: "Bathroom", text: "No mould, musty, or smoke odour present." },
    { id: 7, section: "Bathroom", text: "Caulking and grout in good condition (no missing/black sections)." },
    { id: 8, section: "Bathroom", text: "Faucet secure and not dripping." },
    { id: 9, section: "HVAC", text: "Room gets to set temperature within a reasonable time." },
    { id: 10, section: "HVAC", text: "Thermostat appears to respond to changes correctly." },
    { id: 11, section: "Equipment", text: "Fridge working and door seals properly." },
    { id: 12, section: "Equipment", text: "TV powers on and channels/inputs respond properly." }
  ];
  let nextQuestionId = questions.length + 1;

  let sessions = [];
  let nextSessionId = 1;

  const currentUser = { ...demoEngineers[0] }; // Team lead demo user

  let currentSession = null;
  let currentAnswers = {};
  let currentTimerInterval = null;
  let currentTimerStart = null;
  let selectedInspectionSessionId = null;
  let currentReviewState = {};
  let adminActiveTab = "engineers";
  let roomSortMode = "furthest";
  let currentMode = "RPM";

  // --- Mechanical PM demo data ---

  const mechUnits = [
    { id: "MECH001", name: "Boiler #1 – East Tower", location: "Basement boiler room", type: "Boiler" },
    { id: "MECH002", name: "Boiler #2 – East Tower", location: "Basement boiler room", type: "Boiler" },
    { id: "MECH003", name: "Chiller #1 – River View", location: "Roof level", type: "Chiller" },
    { id: "MECH004", name: "Cooling Tower Cell 1", location: "Roof mechanical yard", type: "Cooling tower" },
    { id: "MECH005", name: "Cooling Tower Cell 2", location: "Roof mechanical yard", type: "Cooling tower" },
    { id: "MECH006", name: "Domestic HW Pump 1A", location: "Basement mech room", type: "Hot water pump" },
    { id: "MECH007", name: "Domestic HW Pump 1B", location: "Basement mech room", type: "Hot water pump" },
    { id: "MECH008", name: "Fire Pump", location: "Fire pump room", type: "Fire pump" },
    { id: "MECH009", name: "Sprinkler Jockey Pump", location: "Fire pump room", type: "Jockey pump" },
    { id: "MECH010", name: "Makeup Air Unit – Corridor 5", location: "Level 5 service corridor", type: "MAU" },
    { id: "MECH011", name: "Pool Dehumidifier", location: "Pool mechanical room", type: "Dehumidifier" },
    { id: "MECH012", name: "Spa Circulation Pump", location: "Spa mechanical room", type: "Pump" }
  ];

  const mechQuestions = [
    { id: 101, section: "General", text: "Unit running smoothly with no abnormal noise or vibration." },
    { id: 102, section: "General", text: "No active alarms on control panel." },
    { id: 103, section: "Safety", text: "Guards, doors, and access panels secure." },
    { id: 104, section: "Safety", text: "Emergency stop tested (where applicable)." },
    { id: 105, section: "Mechanical", text: "No leaks on piping, valves, or seals." },
    { id: 106, section: "Mechanical", text: "Belts, couplings, and moving parts in good condition." },
    { id: 107, section: "Electrical", text: "No exposed wiring; connections appear secure." },
    { id: 108, section: "Housekeeping", text: "Area clear of clutter; safe access around unit." }
  ];

  let mechSessions = [];
  let nextMechSessionId = 1;

  let mechCurrentSession = null;
  let mechCurrentAnswers = {};
  let mechTimerStart = null;
  let mechTimerInterval = null;

  // --- Shared helper ---

  function formatSeconds(sec) {
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
  }

  function hookKeyboardEnterToBlur() {
    function handleKey(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        e.target.blur();
      }
    }
    document.querySelectorAll("input, textarea").forEach(el => {
      if (!el.dataset.enterListener) {
        el.addEventListener("keydown", handleKey);
        el.dataset.enterListener = "1";
      }
    });
  }

  // --- RPM logic ---

  function getTotalRoomsForTarget() {
    return demoRooms.length;
  }

  function getPeriodProgress(year, period) {
    const filtered = sessions.filter(s =>
      s.year === Number(year) &&
      s.period === Number(period) &&
      (s.status === "completed" || s.status === "closed")
    );
    const roomsDone = new Set(filtered.map(s => s.roomNumber));
    const doneCount = roomsDone.size;
    const totalRooms = getTotalRoomsForTarget();
    const pct = totalRooms === 0 ? 0 : Math.round((doneCount / totalRooms) * 100);
    return { doneCount, pct, totalRooms };
  }

  function getSummaryForTodayDemo() {
    const completed = sessions.filter(s => s.status === "completed" || s.status === "closed");
    const totalCompleted = completed.length;
    const totalSeconds = completed.reduce((sum, s) => sum + (s.totalSeconds || 0), 0);
    const avgSeconds = totalCompleted ? totalSeconds / totalCompleted : 0;
    const targetPerDay = 10; // demo target
    const target = targetPerDay;
    const delta = totalCompleted - target;
    return {
      totalCompleted,
      target,
      delta,
      avgSeconds
    };
  }

  function getLastCompletedSessionForRoom(roomNumber) {
    const relevant = sessions.filter(s =>
      s.roomNumber === roomNumber &&
      (s.status === "completed" || s.status === "closed")
    );
    if (!relevant.length) return null;
    relevant.sort((a,b) => {
      const ta = new Date(a.endedAt || a.startedAt).getTime();
      const tb = new Date(b.endedAt || b.startedAt).getTime();
      return tb - ta; // newest first
    });
    return relevant[0];
  }

  function getLastDoneTimestamp(roomNumber) {
    const last = getLastCompletedSessionForRoom(roomNumber);
    if (!last) return null;
    const t = last.endedAt || last.startedAt;
    if (!t) return null;
    return new Date(t).getTime();
  }

  function computeEngineerScores() {
    const map = {};
    for (const s of sessions) {
      if (!s.review) continue;
      const code = s.engineerCode;
      if (!map[code]) {
        map[code] = { engineerCode: code, engineerName: s.engineerName, scores: [] };
      }
      if (typeof s.review.score === "number") {
        map[code].scores.push(s.review.score);
      }
    }
    const result = Object.values(map).map(e => {
      const avg = e.scores.length
        ? e.scores.reduce((a,b) => a + b, 0) / e.scores.length
        : 0;
      return {
        engineerCode: e.engineerCode,
        engineerName: e.engineerName,
        avgScore: Math.round(avg)
      };
    });
    result.sort((a,b) => b.avgScore - a.avgScore);
    return result;
  }

  function renderPeriodProgress() {
    const year = document.getElementById("yearSelect").value;
    const period = document.getElementById("periodSelect").value;
    const { doneCount, pct, totalRooms } = getPeriodProgress(year, period);
    const bar = document.getElementById("periodProgressBar");
    const label = document.getElementById("periodProgressLabel");
    const pctLabel = document.getElementById("periodProgressPct");

    bar.style.height = pct + "%";
    label.textContent = `${doneCount} / ${totalRooms} demo rooms completed`;
    pctLabel.textContent = `${pct}% of period target (demo).`;
  }

  function renderSummary() {
    const s = getSummaryForTodayDemo();
    document.getElementById("summaryCompleted").textContent =
      `${s.totalCompleted} RPMs completed (demo)`;
    document.getElementById("summaryTarget").textContent =
      `Demo target: ${s.target} · Δ ${s.delta >= 0 ? "+" : ""}${s.delta}`;
    document.getElementById("summaryAvgTime").textContent =
      `Avg time: ${Math.round(s.avgSeconds/60)} min`;
  }

  function computeRoomStatusForMap(roomNumber) {
    if (currentSession && currentSession.roomNumber === roomNumber &&
        (currentSession.status === "in_progress" || currentSession.status === "paused")) {
      return "in-progress";
    }
    const year = Number(document.getElementById("yearSelect").value);
    const period = Number(document.getElementById("periodSelect").value);
    const anyCompleted = sessions.some(s =>
      s.roomNumber === roomNumber &&
      s.year === year &&
      s.period === period &&
      (s.status === "completed" || s.status === "closed")
    );
    return anyCompleted ? "done" : "todo";
  }

  function renderRoomMap() {
    const container = document.getElementById("roomMap");
    container.innerHTML = "";

    const roomsCopy = demoRooms.slice();
    let sortedRooms;

    if (roomSortMode === "room") {
      sortedRooms = roomsCopy.sort((a, b) => Number(a) - Number(b));
    } else {
      // sort by furthest last done
      sortedRooms = roomsCopy.sort((a, b) => {
        const ta = getLastDoneTimestamp(a);
        const tb = getLastDoneTimestamp(b);
        if (ta === null && tb === null) return Number(a) - Number(b);
        if (ta === null) return -1;  // never done comes first
        if (tb === null) return 1;
        return ta - tb; // older last-done first
      });
    }

    sortedRooms.forEach(room => {
      const div = document.createElement("div");
      div.className = "room-chip " + computeRoomStatusForMap(room);
      div.textContent = room;
      div.title = "Click to start RPM for room " + room;
      div.addEventListener("click", () => {
        const roomInput = document.getElementById("roomInput");
        roomInput.value = room;
        roomInput.blur();
        updateLastPmInfo(room);
        document.getElementById("startBtn").scrollIntoView({ behavior:"smooth", block:"center" });
      });
      container.appendChild(div);
    });
  }

  function resetCurrentAnswers() {
    currentAnswers = {};
    questions.forEach(q => {
      currentAnswers[q.id] = { answer: null, note: "" };
    });
  }

  function renderChecklist() {
    const container = document.getElementById("checklistContainer");
    container.innerHTML = "";

    if (!currentSession ||
        (currentSession.status !== "in_progress" && currentSession.status !== "paused")) {
      container.innerHTML =
        '<div style="font-size:0.75rem;color:var(--muted);">Start an RPM session above to see the checklist.</div>';
      return;
    }

    const sectionOrder = ["Bathroom","HVAC","Equipment"];

    sectionOrder.forEach(sectionName => {
      questions
        .filter(q => q.section === sectionName)
        .forEach(q => {
          const block = document.createElement("div");
          block.className = "question-block";
          block.dataset.questionId = String(q.id);

          const header = document.createElement("div");
          header.className = "question-header";

          const left = document.createElement("div");
          const qText = document.createElement("div");
          qText.className = "question-text";
          qText.textContent = q.text;
          const qSec = document.createElement("div");
          qSec.className = "question-section";
          qSec.textContent = sectionName;
          left.appendChild(qText);
          left.appendChild(qSec);
          header.appendChild(left);
          block.appendChild(header);

          const btnRow = document.createElement("div");
          btnRow.className = "answer-buttons";

          ["yes","no","na"].forEach(kind => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "answer-btn " + kind;
            btn.textContent = kind.toUpperCase();
            btn.addEventListener("click", () => {
              selectAnswer(q.id, kind, block, btn);
            });
            btnRow.appendChild(btn);
          });

          block.appendChild(btnRow);

          const meta = document.createElement("div");
          meta.className = "question-meta";
          const ansSpan = document.createElement("span");
          ansSpan.textContent = "Answer: –";
          ansSpan.dataset.metaType = "answer";
          const noteSpan = document.createElement("span");
          noteSpan.textContent = "";
          noteSpan.dataset.metaType = "note";

          const noteBtn = document.createElement("button");
          noteBtn.type = "button";
          noteBtn.className = "secondary";
          noteBtn.style.fontSize = "0.65rem";
          noteBtn.textContent = "Add note";
          noteBtn.addEventListener("click", () => {
            const note = prompt("Note for this question:", currentAnswers[q.id].note || "");
            if (note !== null) {
              currentAnswers[q.id].note = note.trim();
              noteSpan.textContent = note ? "Note: " + note : "";
            }
          });

          meta.appendChild(ansSpan);
          meta.appendChild(noteSpan);
          meta.appendChild(noteBtn);
          block.appendChild(meta);

          container.appendChild(block);
        });
    });

    hookKeyboardEnterToBlur();
  }

  function selectAnswer(questionId, answer, block, clickedBtn) {
    currentAnswers[questionId].answer = answer;
    const btns = block.querySelectorAll(".answer-btn");
    btns.forEach(btn => {
      btn.classList.remove("selected", "yes", "no", "na");
      if (btn === clickedBtn) {
        btn.classList.add("selected", answer);
      }
    });
    const metaAns = block.querySelector(".question-meta span[data-meta-type='answer']");
    if (metaAns) {
      metaAns.textContent = "Answer: " + answer.toUpperCase();
    }
  }

  function renderActiveSession() {
    const pill = document.getElementById("activeStatusPill");
    const badges = document.getElementById("timerBadges");
    badges.innerHTML = "";

    if (!currentSession) {
      pill.textContent = "No active room";
      pill.className = "pill accent";
      return;
    }

    const statusLabel = currentSession.status === "in_progress" ? "In progress" :
                        currentSession.status === "paused" ? "Paused" :
                        currentSession.status;
    pill.textContent = `Room ${currentSession.roomNumber} · ${statusLabel}`;
    pill.className = "pill accent";

    const b1 = document.createElement("span");
    b1.className = "pill";
    b1.textContent = `Engineer (demo): ${currentSession.engineerName}`;
    badges.appendChild(b1);

    const b2 = document.createElement("span");
    b2.className = "pill";
    b2.textContent = `Period: ${currentSession.period}, Year: ${currentSession.year}`;
    badges.appendChild(b2);
  }

  function renderTimer() {
    const display = document.getElementById("timerDisplay");
    if (!currentSession) {
      display.textContent = "00:00";
      return;
    }
    let base = currentSession.totalSeconds || 0;
    if (currentSession.status === "in_progress" && currentTimerStart != null) {
      const elapsed = (Date.now() - currentTimerStart) / 1000;
      base += elapsed;
    }
    display.textContent = formatSeconds(base);
  }

  function startTimer() {
    if (currentTimerInterval) clearInterval(currentTimerInterval);
    currentTimerStart = Date.now();
    currentTimerInterval = setInterval(renderTimer, 1000);
  }

  function pauseTimer() {
    if (!currentSession || currentSession.status !== "in_progress") return;
    const elapsed = (Date.now() - currentTimerStart) / 1000;
    currentSession.totalSeconds = (currentSession.totalSeconds || 0) + elapsed;
    currentTimerStart = null;
    currentSession.status = "paused";
    if (currentTimerInterval) clearInterval(currentTimerInterval);
    renderTimer();
    renderActiveSession();
  }

  function stopTimerAndComplete() {
    if (!currentSession) return;
    if (currentSession.status === "in_progress" && currentTimerStart != null) {
      const elapsed = (Date.now() - currentTimerStart) / 1000;
      currentSession.totalSeconds = (currentSession.totalSeconds || 0) + elapsed;
    }
    currentTimerStart = null;
    if (currentTimerInterval) clearInterval(currentTimerInterval);
    currentTimerInterval = null;
    renderTimer();
  }

  function clearActiveSessionState() {
    currentSession = null;
    currentTimerStart = null;
    if (currentTimerInterval) clearInterval(currentTimerInterval);
    currentTimerInterval = null;
    renderTimer();
    renderActiveSession();
    document.getElementById("roomInput").value = "";
    document.getElementById("overallNotes").value = "";
    resetCurrentAnswers();
    renderChecklist();
    updateButtonsForStatus();
    updateLastPmInfo("");
    renderRoomMap();
  }

  function updateButtonsForStatus() {
    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const resumeBtn = document.getElementById("resumeBtn");
    const completeBtn = document.getElementById("completeBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const completeBottom = document.getElementById("completeBtnBottom");

    if (!currentSession) {
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
      completeBtn.disabled = true;
      cancelBtn.disabled = true;
      completeBottom.disabled = true;
      return;
    }

    if (currentSession.status === "in_progress") {
      startBtn.disabled = true;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      completeBtn.disabled = false;
      cancelBtn.disabled = false;
      completeBottom.disabled = false;
    } else if (currentSession.status === "paused") {
      startBtn.disabled = true;
      pauseBtn.disabled = true;
      resumeBtn.disabled = false;
      completeBtn.disabled = false;
      cancelBtn.disabled = false;
      completeBottom.disabled = false;
    } else {
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
      completeBtn.disabled = true;
      cancelBtn.disabled = true;
      completeBottom.disabled = true;
    }
  }

  function allQuestionsAnswered() {
    return questions.every(q => {
      const ans = currentAnswers[q.id];
      return ans && ans.answer;
    });
  }

  function renderSessionsTable() {
    const tbody = document.querySelector("#sessionsTable tbody");
    tbody.innerHTML = "";
    sessions
      .filter(s => s.status === "completed" || s.status === "closed")
      .sort((a,b) => a.id - b.id)
      .forEach(s => {
        const tr = document.createElement("tr");

        const tdRoom = document.createElement("td");
        tdRoom.textContent = s.roomNumber;
        tr.appendChild(tdRoom);

        const tdEng = document.createElement("td");
        tdEng.textContent = s.engineerName;
        tr.appendChild(tdEng);

        const tdDur = document.createElement("td");
        tdDur.textContent = formatSeconds(s.totalSeconds || 0);
        tr.appendChild(tdDur);

        const tdStatus = document.createElement("td");
        tdStatus.textContent = s.status === "closed" ? "Closed" : "Completed";
        tr.appendChild(tdStatus);

        const tdRev = document.createElement("td");
        if (s.review) {
          tdRev.innerHTML =
            '<span style="color:' + (s.review.pass ? '#16a34a' : '#e11d48') + ';">' +
            (s.review.pass ? "Pass" : "Fail") +
            "</span><br><small>" + s.review.score + "%</small>";
        } else {
          tdRev.innerHTML = '<span style="color:#f59e0b;">Not reviewed</span>';
        }
        tr.appendChild(tdRev);

        const tdAction = document.createElement("td");
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "Inspect";
        btn.className = "secondary";
        btn.addEventListener("click", () => openInspection(s.id));
        tdAction.appendChild(btn);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
  }

  function renderRanking() {
    const container = document.getElementById("rankingBars");
    container.innerHTML = "";
    const scores = computeEngineerScores();
    if (!scores.length) {
      container.textContent = "No RPM inspections yet in this demo.";
      document.getElementById("topEngineerName").textContent = "–";
      document.getElementById("topEngineerScore").textContent = "Avg score: –";
      return;
    }
    scores.forEach(e => {
      const row = document.createElement("div");
      row.className = "bar-row";
      const lbl = document.createElement("div");
      lbl.className = "bar-label";
      lbl.textContent = e.engineerName;
      const track = document.createElement("div");
      track.className = "bar-track";
      const fill = document.createElement("div");
      fill.className = "bar-fill";
      fill.style.width = e.avgScore + "%";
      track.appendChild(fill);
      const val = document.createElement("div");
      val.className = "bar-value";
      val.textContent = e.avgScore + "%";
      row.appendChild(lbl);
      row.appendChild(track);
      row.appendChild(val);
      container.appendChild(row);
    });

    const top = scores[0];
    document.getElementById("topEngineerName").textContent = top.engineerName;
    document.getElementById("topEngineerScore").textContent = "Avg score: " + top.avgScore + "%";
  }

  function openInspection(sessionId) {
    selectedInspectionSessionId = sessionId;
    const session = sessions.find(s => s.id === sessionId);
    const headerLabel = document.getElementById("inspectHeaderLabel");
    headerLabel.textContent = "Inspecting RPM for room " + session.roomNumber + " · " + session.engineerName;
    headerLabel.className = "pill success";

    currentReviewState = {};
    const existing = session.review;
    if (existing && existing.items) {
      existing.items.forEach(item => {
        currentReviewState[item.questionId] = item.status;
      });
    } else {
      questions.forEach(q => {
        currentReviewState[q.id] = "na";
      });
    }

    const panel = document.getElementById("inspectionPanel");
    panel.innerHTML = "";

    const info = document.createElement("div");
    info.style.marginBottom = "6px";
    info.innerHTML =
      '<div style="margin-bottom:4px;">Room <strong>' + session.roomNumber +
      "</strong> · Engineer <strong>" + session.engineerName + "</strong></div>" +
      '<div style="font-size:0.7rem;color:var(--muted);">' +
      "Duration: " + formatSeconds(session.totalSeconds || 0) +
      " · Status: " + (session.status === "closed" ? "Closed" : "Completed (awaiting review)") +
      "</div>" +
      '<div style="font-size:0.7rem;color:var(--muted);margin-top:4px;">' +
      "Engineer notes: " + (session.overallNotes || "<em>None</em>") +
      "</div>";
    panel.appendChild(info);

    const list = document.createElement("div");
    list.style.maxHeight = "240px";
    list.style.overflowY = "auto";
    list.style.paddingRight = "4px";

    questions.forEach(q => {
      const ans = session.answers.find(a => a.questionId === q.id);
      const engineerAnswer = ans ? ans.answer.toUpperCase() : "–";
      const engineerNote = ans && ans.note ? ans.note : "";

      const box = document.createElement("div");
      box.className = "inspect-box";

      const title = document.createElement("div");
      title.style.fontSize = "0.8rem";
      title.textContent = q.text;
      box.appendChild(title);

      const sub = document.createElement("div");
      sub.style.fontSize = "0.7rem";
      sub.style.color = "var(--muted)";
      sub.innerHTML =
        "Engineer answer: <strong>" + engineerAnswer + "</strong>" +
        (engineerNote ? " · Note: " + engineerNote : "");
      box.appendChild(sub);

      const controls = document.createElement("div");
      controls.style.display = "flex";
      controls.style.flexWrap = "wrap";
      controls.style.gap = "4px";
      controls.style.marginTop = "4px";

      ["pass","fail","na"].forEach(kind => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "answer-btn " + (kind === "pass" ? "yes" : kind === "fail" ? "no" : "na");
        btn.style.fontSize = "0.7rem";
        btn.textContent = kind.toUpperCase();
        if (currentReviewState[q.id] === kind) {
          btn.classList.add("selected");
        }
        btn.addEventListener("click", () => {
          currentReviewState[q.id] = kind;
          const siblings = controls.querySelectorAll(".answer-btn");
          siblings.forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
        });
        controls.appendChild(btn);
      });

      box.appendChild(controls);
      list.appendChild(box);
    });

    panel.appendChild(list);

    const notesField = document.createElement("div");
    notesField.className = "field";
    notesField.style.marginTop = "6px";
    const label = document.createElement("label");
    label.textContent = "Overall review notes";
    const textarea = document.createElement("textarea");
    textarea.id = "reviewNotes";
    textarea.placeholder = "Summary of this RPM inspection (demo).";
    textarea.value = session.review && session.review.notes ? session.review.notes : "";
    notesField.appendChild(label);
    notesField.appendChild(textarea);
    panel.appendChild(notesField);

    const actionRow = document.createElement("div");
    actionRow.style.marginTop = "6px";
    actionRow.style.display = "flex";
    actionRow.style.gap = "6px";
    const saveBtn = document.createElement("button");
    saveBtn.type = "button";
    saveBtn.textContent = "Save review";
    const passFailHint = document.createElement("div");
    passFailHint.style.fontSize = "0.7rem";
    passFailHint.style.color = "var(--muted)";
    passFailHint.style.marginLeft = "8px";
    passFailHint.textContent = "Score is based on PASS vs FAIL (NA ignored).";

    saveBtn.addEventListener("click", () => {
      saveReviewForSession(session.id);
    });

    actionRow.appendChild(saveBtn);
    panel.appendChild(actionRow);
    panel.appendChild(passFailHint);

    hookKeyboardEnterToBlur();
  }

  function saveReviewForSession(sessionId) {
    const session = sessions.find(s => s.id === sessionId);
    if (!session) return;
    const notes = document.getElementById("reviewNotes").value.trim();

    let passCount = 0;
    let failCount = 0;
    questions.forEach(q => {
      const st = currentReviewState[q.id];
      if (st === "pass") passCount++;
      else if (st === "fail") failCount++;
    });
    const denom = passCount + failCount;
    const score = denom ? Math.round((passCount / denom) * 100) : 0;
    const passBool = failCount === 0;

    const items = questions.map(q => ({
      questionId: q.id,
      status: currentReviewState[q.id] || "na",
      note: ""
    }));

    session.review = {
      reviewerName: currentUser.name,
      score,
      pass: passBool,
      notes,
      items
    };
    session.status = "closed";

    renderSessionsTable();
    renderRanking();
    renderSummary();
    renderPeriodProgress();
    renderRoomMap();

    const headerLabel = document.getElementById("inspectHeaderLabel");
    headerLabel.textContent = "Review saved · Score " + session.review.score + "%";
    headerLabel.className = "pill success";
  }

  // --- Admin demo helpers (RPM) ---

  function renameRoom(oldRoom, newRoom) {
    const idx = demoRooms.indexOf(oldRoom);
    if (idx !== -1) {
      demoRooms[idx] = newRoom;
    }
    sessions.forEach(s => {
      if (s.roomNumber === oldRoom) {
        s.roomNumber = newRoom;
      }
    });
  }

  function renderAdminEngineers(container) {
    const list = document.createElement("div");
    list.className = "admin-list";

    demoEngineers.forEach(eng => {
      const item = document.createElement("div");
      item.className = "admin-list-item";

      const main = document.createElement("div");
      main.className = "admin-list-main";
      const title = document.createElement("div");
      title.className = "admin-title";
      title.textContent = eng.name;
      const sub = document.createElement("div");
      sub.className = "admin-sub";
      sub.textContent = "Code: " + eng.code + " · Role: " + eng.role;
      main.appendChild(title);
      main.appendChild(sub);

      const actions = document.createElement("div");
      actions.className = "admin-actions";
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "secondary";
      editBtn.textContent = "Edit";
      editBtn.addEventListener("click", () => {
        const newName = prompt("Engineer name:", eng.name);
        if (newName === null) return;
        const newRole = prompt("Role (engineer/team_lead/admin):", eng.role);
        if (newRole === null) return;
        const trimmedName = newName.trim();
        const trimmedRole = (newRole || "").trim().toLowerCase();
        if (trimmedName) eng.name = trimmedName;
        if (["engineer","team_lead","admin"].includes(trimmedRole)) {
          eng.role = trimmedRole;
        }
        if (eng.code === currentUser.code) {
          currentUser.name = eng.name;
        }
        sessions.forEach(s => {
          if (s.engineerCode === eng.code) {
            s.engineerName = eng.name;
          }
        });
        renderAdminPanel();
        renderSessionsTable();
        renderRanking();
        renderActiveSession();
      });
      actions.appendChild(editBtn);

      item.appendChild(main);
      item.appendChild(actions);
      list.appendChild(item);
    });

    container.appendChild(list);

    const footer = document.createElement("div");
    footer.className = "admin-footer-actions";
    const addBtn = document.createElement("button");
    addBtn.type = "button";
    addBtn.textContent = "Add engineer";
    addBtn.className = "secondary";
    addBtn.addEventListener("click", () => {
      const name = prompt("New engineer name:");
      if (!name || !name.trim()) return;
      const code = prompt("Login code (demo):", "ENG" + String(demoEngineers.length + 1).padStart(3,"0"));
      if (!code || !code.trim()) return;
      const role = prompt("Role (engineer/team_lead/admin):", "engineer") || "engineer";
      demoEngineers.push({
        code: code.trim(),
        name: name.trim(),
        role: role.trim().toLowerCase()
      });
      renderAdminPanel();
    });
    footer.appendChild(addBtn);

    const info = document.createElement("div");
    info.style.fontSize = "0.65rem";
    info.style.color = "var(--muted)";
    info.textContent = "Demo only: this does not affect Supabase or real users.";
    footer.appendChild(info);

    container.appendChild(footer);
  }

  function renderAdminRooms(container) {
    const list = document.createElement("div");
    list.className = "admin-list";

    demoRooms
      .slice()
      .sort((a,b) => Number(a) - Number(b))
      .forEach(room => {
        const item = document.createElement("div");
        item.className = "admin-list-item";

        const main = document.createElement("div");
        main.className = "admin-list-main";
        const title = document.createElement("div");
        title.className = "admin-title";
        title.textContent = "Room " + room;
        const sub = document.createElement("div");
        sub.className = "admin-sub";
        sub.textContent = "Demo room entry";
        main.appendChild(title);
        main.appendChild(sub);

        const actions = document.createElement("div");
        actions.className = "admin-actions";
        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "secondary";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => {
          const newRoom = prompt("New room number:", room);
          if (newRoom === null) return;
          const trimmed = newRoom.trim();
          if (!trimmed) return;
          renameRoom(room, trimmed);
          renderAdminPanel();
          renderRoomMap();
          renderSessionsTable();
          renderPeriodProgress();
        });
        actions.appendChild(editBtn);

        item.appendChild(main);
        item.appendChild(actions);
        list.appendChild(item);
      });

    container.appendChild(list);

    const footer = document.createElement("div");
    footer.className = "admin-footer-actions";
    const addBtn = document.createElement("button");
    addBtn.type = "button";
    addBtn.textContent = "Add room";
    addBtn.className = "secondary";
    addBtn.addEventListener("click", () => {
      const newRoom = prompt("Room number to add (demo):");
      if (!newRoom || !newRoom.trim()) return;
      const val = newRoom.trim();
      if (!demoRooms.includes(val)) {
        demoRooms.push(val);
      }
      renderAdminPanel();
      renderRoomMap();
      renderPeriodProgress();
    });
    footer.appendChild(addBtn);

    const info = document.createElement("div");
    info.style.fontSize = "0.65rem";
    info.style.color = "var(--muted)";
    info.textContent = "Demo only: does not change your real room list.";
    footer.appendChild(info);

    container.appendChild(footer);
  }

  function renderAdminQuestions(container) {
    const list = document.createElement("div");
    list.className = "admin-list";

    questions.forEach(q => {
      const item = document.createElement("div");
      item.className = "admin-list-item";

      const main = document.createElement("div");
      main.className = "admin-list-main";
      const title = document.createElement("div");
      title.className = "admin-title";
      title.textContent = q.text;
      const sub = document.createElement("div");
      sub.className = "admin-sub";
      sub.textContent = "Section: " + q.section + " · ID: " + q.id;
      main.appendChild(title);
      main.appendChild(sub);

      const actions = document.createElement("div");
      actions.className = "admin-actions";
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "secondary";
      editBtn.textContent = "Edit";
      editBtn.addEventListener("click", () => {
        const newText = prompt("Question text:", q.text);
        if (newText === null) return;
        const newSection = prompt("Section (Bathroom/HVAC/Equipment):", q.section);
        if (newSection === null) return;
        const t = newText.trim();
        const s = newSection.trim();
        if (t) q.text = t;
        if (s) q.section = s;
        renderAdminPanel();
        renderChecklist();
        if (selectedInspectionSessionId) {
          openInspection(selectedInspectionSessionId);
        }
      });
      actions.appendChild(editBtn);

      item.appendChild(main);
      item.appendChild(actions);
      list.appendChild(item);
    });

    container.appendChild(list);

    const footer = document.createElement("div");
    footer.className = "admin-footer-actions";
    const addBtn = document.createElement("button");
    addBtn.type = "button";
    addBtn.textContent = "Add question";
    addBtn.className = "secondary";
    addBtn.addEventListener("click", () => {
      const section = prompt("Section (Bathroom/HVAC/Equipment or other):", "Bathroom");
      if (section === null) return;
      const text = prompt("Question text:");
      if (!text || !text.trim()) return;
      questions.push({
        id: nextQuestionId++,
        section: section.trim(),
        text: text.trim()
      });
      renderAdminPanel();
      renderChecklist();
    });
    footer.appendChild(addBtn);

    const info = document.createElement("div");
    info.style.fontSize = "0.65rem";
    info.style.color = "var(--muted)";
    info.textContent = "Demo only: use this to try different wording and sections.";
    footer.appendChild(info);

    container.appendChild(footer);
  }

  function renderAdminPanel() {
    const container = document.getElementById("adminContent");
    if (!container) return;
    container.innerHTML = "";

    document.querySelectorAll(".admin-tab-btn").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tab === adminActiveTab);
    });

    if (adminActiveTab === "engineers") {
      renderAdminEngineers(container);
    } else if (adminActiveTab === "rooms") {
      renderAdminRooms(container);
    } else {
      renderAdminQuestions(container);
    }
  }

  function updateLastPmInfo(roomNumber) {
    const infoDiv = document.getElementById("lastPmInfo");
    if (!roomNumber) {
      infoDiv.textContent =
        "Click a room above to view when it was last done, by who, and their score (demo).";
      return;
    }
    const last = getLastCompletedSessionForRoom(roomNumber);
    if (!last) {
      infoDiv.textContent =
        "Room " + roomNumber + " has never been completed in this demo data.";
      return;
    }
    const tStr = last.endedAt || last.startedAt;
    let dateStr = "Unknown date";
    if (tStr) {
      dateStr = new Date(tStr).toLocaleString("en-CA", { timeZone: "America/Toronto" });
    }
    const scoreText = last.review
      ? last.review.score + "% (" + (last.review.pass ? "PASS" : "FAIL") + ")"
      : "Not inspected yet";
    infoDiv.textContent =
      "Last RPM: " + dateStr +
      " · Engineer: " + last.engineerName +
      " · Score: " + scoreText;
  }

  // --- Seed RPM demo data ---

  function seedDemoSessions() {
    const generated = [];
    let idCounter = 1;
    const baseDate = new Date("2025-01-01T09:00:00-05:00");
    const periods = [1,2,3];

    demoRooms.forEach((room, idx) => {
      const rand = Math.random();
      let numSessions;
      if (rand < 0.3) numSessions = 0;
      else if (rand < 0.8) numSessions = 1;
      else numSessions = 2;

      for (let i = 0; i < numSessions; i++) {
        const engineer = demoEngineers[Math.floor(Math.random() * demoEngineers.length)];
        const period = periods[(idx + i) % periods.length];
        const dayOffset = Math.floor(Math.random() * 180); // within ~6 months
        const startDate = new Date(baseDate.getTime() + dayOffset * 24 * 60 * 60 * 1000);
        const durationMinutes = 15 + Math.floor(Math.random() * 26); // 15–40 min
        const endDate = new Date(startDate.getTime() + durationMinutes * 60 * 1000);

        const answersArr = questions.map(q => {
          const r = Math.random();
          let ans;
          if (r < 0.7) ans = "yes";
          else if (r < 0.9) ans = "no";
          else ans = "na";
          const note = ans === "no" && Math.random() < 0.5 ? "Issue logged for follow-up." : "";
          return { questionId: q.id, answer: ans, note };
        });

        let reviewObj = null;
        if (Math.random() < 0.7) {
          let passCount = 0;
          let failCount = 0;
          const reviewItems = questions.map(q => {
            const ansObj = answersArr.find(a => a.questionId === q.id);
            let status;
            if (!ansObj || ansObj.answer === "na") status = "na";
            else if (ansObj.answer === "yes") status = "pass";
            else status = "fail";
            if (status === "pass") passCount++;
            else if (status === "fail") failCount++;
            return { questionId: q.id, status, note: "" };
          });
          const denom = passCount + failCount;
          const score = denom ? Math.round((passCount / denom) * 100) : 0;
          const passBool = failCount === 0 || score >= 75;
          reviewObj = {
            reviewerName: "Alex Carter",
            score,
            pass: passBool,
            notes: passBool ? "Spot check complete." : "Issues to monitor.",
            items: reviewItems
          };
        }

        generated.push({
          id: idCounter++,
          roomNumber: room,
          engineerCode: engineer.code,
          engineerName: engineer.name,
          year: 2025,
          period,
          status: reviewObj ? "closed" : "completed",
          startedAt: startDate.toISOString(),
          endedAt: endDate.toISOString(),
          totalSeconds: durationMinutes * 60,
          overallNotes: "",
          answers: answersArr,
          review: reviewObj
        });
      }
    });

    sessions = generated;
    nextSessionId = idCounter;
  }

  // --- Mechanical PM logic ---

  function seedMechanicalDemo() {
    const generated = [];
    let idCounter = 1;
    const baseDate = new Date("2025-01-01T07:00:00-05:00");
    const periods = [1,2,3];

    mechUnits.forEach((unit, idx) => {
      const rand = Math.random();
      let numSessions;
      if (rand < 0.3) numSessions = 1;
      else if (rand < 0.8) numSessions = 2;
      else numSessions = 3;

      for (let i = 0; i < numSessions; i++) {
        const engineer = demoEngineers[Math.floor(Math.random() * demoEngineers.length)];
        const period = periods[(idx + i) % periods.length];
        const dayOffset = Math.floor(Math.random() * 180);
        const startDate = new Date(baseDate.getTime() + dayOffset * 24 * 60 * 60 * 1000);
        const durationMinutes = 20 + Math.floor(Math.random() * 31); // 20–50 min
        const endDate = new Date(startDate.getTime() + durationMinutes * 60 * 1000);

        const answersArr = mechQuestions.map(q => {
          const r = Math.random();
          let ans;
          if (r < 0.75) ans = "yes";
          else if (r < 0.9) ans = "no";
          else ans = "na";
          const note = ans === "no" && Math.random() < 0.6 ? "Requires follow-up work order." : "";
          return { questionId: q.id, answer: ans, note };
        });

        let passCount = 0;
        let failCount = 0;
        const reviewItems = mechQuestions.map(q => {
          const ansObj = answersArr.find(a => a.questionId === q.id);
          let status;
          if (!ansObj || ansObj.answer === "na") status = "na";
          else if (ansObj.answer === "yes") status = "pass";
          else status = "fail";
          if (status === "pass") passCount++;
          else if (status === "fail") failCount++;
          return { questionId: q.id, status, note: "" };
        });
        const denom = passCount + failCount;
        const score = denom ? Math.round((passCount / denom) * 100) : 0;
        const passBool = score >= 80;

        const reviewObj = {
          reviewerName: "Alex Carter",
          score,
          pass: passBool,
          notes: passBool ? "Mechanical PM looks good." : "Monitor this unit closely.",
          items: reviewItems
        };

        generated.push({
          id: idCounter++,
          unitId: unit.id,
          unitName: unit.name,
          engineerCode: engineer.code,
          engineerName: engineer.name,
          year: 2025,
          period,
          status: "closed",
          startedAt: startDate.toISOString(),
          endedAt: endDate.toISOString(),
          totalSeconds: durationMinutes * 60,
          overallNotes: "",
          answers: answersArr,
          review: reviewObj
        });
      }
    });

    mechSessions = generated;
    nextMechSessionId = idCounter;
  }

  function getMechPeriodProgress(year, period) {
    const filtered = mechSessions.filter(s =>
      s.year === Number(year) &&
      s.period === Number(period) &&
      (s.status === "completed" || s.status === "closed")
    );
    const unitsDone = new Set(filtered.map(s => s.unitId));
    const doneCount = unitsDone.size;
    const totalUnits = mechUnits.length;
    const pct = totalUnits === 0 ? 0 : Math.round((doneCount / totalUnits) * 100);
    return { doneCount, pct, totalUnits };
  }

  function getMechSummaryForTodayDemo() {
    const completed = mechSessions.filter(s => s.status === "completed" || s.status === "closed");
    const totalCompleted = completed.length;
    const totalSeconds = completed.reduce((sum, s) => sum + (s.totalSeconds || 0), 0);
    const avgSeconds = totalCompleted ? totalSeconds / totalCompleted : 0;
    const targetPerDay = 5; // demo target for mechanical
    const target = targetPerDay;
    const delta = totalCompleted - target;
    return {
      totalCompleted,
      target,
      delta,
      avgSeconds
    };
  }

  function renderMechPeriodProgress() {
    const year = document.getElementById("mechYearSelect").value;
    const period = document.getElementById("mechPeriodSelect").value;
    const { doneCount, pct, totalUnits } = getMechPeriodProgress(year, period);

    const bar = document.getElementById("mechPeriodProgressBar");
    const label = document.getElementById("mechPeriodProgressLabel");
    const pctLabel = document.getElementById("mechPeriodProgressPct");

    bar.style.height = pct + "%";
    label.textContent = `${doneCount} / ${totalUnits} units completed`;
    pctLabel.textContent = `${pct}% of period target (demo).`;
  }

  function renderMechSummary() {
    const s = getMechSummaryForTodayDemo();
    document.getElementById("mechSummaryCompleted").textContent =
      `${s.totalCompleted} mechanical PMs completed (demo)`;
    document.getElementById("mechSummaryTarget").textContent =
      `Demo target: ${s.target} · Δ ${s.delta >= 0 ? "+" : ""}${s.delta}`;
    document.getElementById("mechSummaryAvgTime").textContent =
      `Avg time: ${Math.round(s.avgSeconds/60)} min`;
  }

  function getMechLastCompletedSessionForUnit(unitId) {
    const relevant = mechSessions.filter(s =>
      s.unitId === unitId &&
      (s.status === "completed" || s.status === "closed")
    );
    if (!relevant.length) return null;
    relevant.sort((a,b) => {
      const ta = new Date(a.endedAt || a.startedAt).getTime();
      const tb = new Date(b.endedAt || b.startedAt).getTime();
      return tb - ta;
    });
    return relevant[0];
  }

  function getMechLastDoneTimestamp(unitId) {
    const last = getMechLastCompletedSessionForUnit(unitId);
    if (!last) return null;
    const t = last.endedAt || last.startedAt;
    if (!t) return null;
    return new Date(t).getTime();
  }

  function renderMechUnits() {
    const grid = document.getElementById("mechUnitGrid");
    grid.innerHTML = "";

    const year = Number(document.getElementById("mechYearSelect").value);
    const period = Number(document.getElementById("mechPeriodSelect").value);

    mechUnits.forEach(unit => {
      const div = document.createElement("div");
      let statusClass = "todo";
      const anyCompleted = mechSessions.some(s =>
        s.unitId === unit.id &&
        s.year === year &&
        s.period === period &&
        (s.status === "completed" || s.status === "closed")
      );
      if (anyCompleted) statusClass = "done";
      if (mechCurrentSession && mechCurrentSession.unitId === unit.id &&
          (mechCurrentSession.status === "in_progress" || mechCurrentSession.status === "paused")) {
        statusClass = "in-progress";
      }
      div.className = "room-chip " + statusClass;
      div.textContent = unit.name.replace(" –", "");
      div.title = `${unit.name}\n${unit.location}\nType: ${unit.type}`;
      div.addEventListener("click", () => {
        const sel = document.getElementById("mechUnitSelect");
        sel.value = unit.id;
        sel.blur();
        updateMechLastPmInfo(unit.id);
        document.getElementById("mechStartBtn").scrollIntoView({ behavior:"smooth", block:"center" });
      });
      grid.appendChild(div);
    });
  }

  function renderMechSessionsTable() {
    const tbody = document.querySelector("#mechSessionsTable tbody");
    tbody.innerHTML = "";

    mechSessions
      .slice()
      .sort((a,b) => a.id - b.id)
      .forEach(s => {
        const tr = document.createElement("tr");

        const tdUnit = document.createElement("td");
        tdUnit.textContent = s.unitName;
        tr.appendChild(tdUnit);

        const tdEng = document.createElement("td");
        tdEng.textContent = s.engineerName;
        tr.appendChild(tdEng);

        const tdDur = document.createElement("td");
        tdDur.textContent = formatSeconds(s.totalSeconds || 0);
        tr.appendChild(tdDur);

        const tdStatus = document.createElement("td");
        tdStatus.textContent = s.status === "closed" ? "Closed" : "Completed";
        tr.appendChild(tdStatus);

        const tdRev = document.createElement("td");
        if (s.review) {
          tdRev.innerHTML =
            '<span style="color:' + (s.review.pass ? '#16a34a' : '#e11d48') + ';">' +
            (s.review.pass ? "Pass" : "Fail") +
            "</span><br><small>" + s.review.score + "%</small>";
        } else {
          tdRev.innerHTML = '<span style="color:#f59e0b;">Not reviewed</span>';
        }
        tr.appendChild(tdRev);

        const tdAction = document.createElement("td");
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "View";
        btn.className = "secondary";
        btn.addEventListener("click", () => openMechInspection(s.id));
        tdAction.appendChild(btn);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
  }

  function computeMechEngineerScores() {
    const map = {};
    for (const s of mechSessions) {
      if (!s.review) continue;
      const code = s.engineerCode;
      if (!map[code]) {
        map[code] = { engineerCode: code, engineerName: s.engineerName, scores: [] };
      }
      if (typeof s.review.score === "number") {
        map[code].scores.push(s.review.score);
      }
    }
    const result = Object.values(map).map(e => {
      const avg = e.scores.length
        ? e.scores.reduce((a,b) => a + b, 0) / e.scores.length
        : 0;
      return {
        engineerCode: e.engineerCode,
        engineerName: e.engineerName,
        avgScore: Math.round(avg)
      };
    });
    result.sort((a,b) => b.avgScore - a.avgScore);
    return result;
  }

  function renderMechRanking() {
    const container = document.getElementById("mechRankingBars");
    container.innerHTML = "";
    const scores = computeMechEngineerScores();
    if (!scores.length) {
      container.textContent = "No mechanical PM inspections yet in this demo.";
      document.getElementById("mechTopEngineerName").textContent = "–";
      document.getElementById("mechTopEngineerScore").textContent = "Avg score: –";
      return;
    }

    scores.forEach(e => {
      const row = document.createElement("div");
      row.className = "bar-row";
      const lbl = document.createElement("div");
      lbl.className = "bar-label";
      lbl.textContent = e.engineerName;
      const track = document.createElement("div");
      track.className = "bar-track";
      const fill = document.createElement("div");
      fill.className = "bar-fill";
      fill.style.width = e.avgScore + "%";
      track.appendChild(fill);
      const val = document.createElement("div");
      val.className = "bar-value";
      val.textContent = e.avgScore + "%";
      row.appendChild(lbl);
      row.appendChild(track);
      row.appendChild(val);
      container.appendChild(row);
    });

    const top = scores[0];
    document.getElementById("mechTopEngineerName").textContent = top.engineerName;
    document.getElementById("mechTopEngineerScore").textContent = "Avg score: " + top.avgScore + "%";
  }

  function openMechInspection(sessionId) {
    const panel = document.getElementById("mechInspectionPanel");
    const session = mechSessions.find(s => s.id === sessionId);
    if (!session) {
      panel.textContent = "Mechanical PM not found (demo).";
      return;
    }

    panel.innerHTML = "";
    const info = document.createElement("div");
    info.style.marginBottom = "6px";
    info.innerHTML =
      '<div style="margin-bottom:4px;">Unit <strong>' + session.unitName +
      "</strong> · Engineer <strong>" + session.engineerName + "</strong></div>" +
      '<div style="font-size:0.7rem;color:var(--muted);">' +
      "Duration: " + formatSeconds(session.totalSeconds || 0) +
      " · Status: " + (session.status === "closed" ? "Closed" : "Completed") +
      "</div>" +
      '<div style="font-size:0.7rem;color:var(--muted);margin-top:4px;">' +
      "Review score: " + (session.review ? session.review.score + "% (" + (session.review.pass ? "PASS" : "FAIL") + ")" : "N/A") +
      "</div>";
    panel.appendChild(info);

    const list = document.createElement("div");
    list.style.maxHeight = "240px";
    list.style.overflowY = "auto";
    list.style.paddingRight = "4px";

    mechQuestions.forEach(q => {
      const ans = session.answers.find(a => a.questionId === q.id);
      const engineerAnswer = ans ? ans.answer.toUpperCase() : "–";
      const engineerNote = ans && ans.note ? ans.note : "";

      const box = document.createElement("div");
      box.className = "inspect-box";

      const title = document.createElement("div");
      title.style.fontSize = "0.8rem";
      title.textContent = q.text;
      box.appendChild(title);

      const sub = document.createElement("div");
      sub.style.fontSize = "0.7rem";
      sub.style.color = "var(--muted)";
      sub.innerHTML =
        "Engineer answer: <strong>" + engineerAnswer + "</strong>" +
        (engineerNote ? " · Note: " + engineerNote : "");
      box.appendChild(sub);

      list.appendChild(box);
    });

    panel.appendChild(list);

    if (session.review && session.review.notes) {
      const notesDiv = document.createElement("div");
      notesDiv.style.fontSize = "0.7rem";
      notesDiv.style.color = "var(--muted)";
      notesDiv.style.marginTop = "4px";
      notesDiv.textContent = "Reviewer notes: " + session.review.notes;
      panel.appendChild(notesDiv);
    }
  }

  // Mechanical active session helpers

  function mechResetAnswers() {
    mechCurrentAnswers = {};
    mechQuestions.forEach(q => {
      mechCurrentAnswers[q.id] = { answer: null, note: "" };
    });
  }

  function mechRenderChecklist() {
    const container = document.getElementById("mechChecklistContainer");
    container.innerHTML = "";

    if (!mechCurrentSession ||
        (mechCurrentSession.status !== "in_progress" && mechCurrentSession.status !== "paused")) {
      container.innerHTML =
        '<div style="font-size:0.75rem;color:var(--muted);">Start a mechanical PM session above to see the checklist.</div>';
      return;
    }

    const sectionOrder = ["General","Safety","Mechanical","Electrical","Housekeeping"];

    sectionOrder.forEach(sectionName => {
      mechQuestions
        .filter(q => q.section === sectionName)
        .forEach(q => {
          const block = document.createElement("div");
          block.className = "question-block";
          block.dataset.questionId = String(q.id);

          const header = document.createElement("div");
          header.className = "question-header";

          const left = document.createElement("div");
          const qText = document.createElement("div");
          qText.className = "question-text";
          qText.textContent = q.text;
          const qSec = document.createElement("div");
          qSec.className = "question-section";
          qSec.textContent = sectionName;
          left.appendChild(qText);
          left.appendChild(qSec);
          header.appendChild(left);
          block.appendChild(header);

          const btnRow = document.createElement("div");
          btnRow.className = "answer-buttons";

          ["yes","no","na"].forEach(kind => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "answer-btn " + kind;
            btn.textContent = kind.toUpperCase();
            btn.addEventListener("click", () => {
              mechSelectAnswer(q.id, kind, block, btn);
            });
            btnRow.appendChild(btn);
          });

          block.appendChild(btnRow);

          const meta = document.createElement("div");
          meta.className = "question-meta";
          const ansSpan = document.createElement("span");
          ansSpan.textContent = "Answer: –";
          ansSpan.dataset.metaType = "answer";
          const noteSpan = document.createElement("span");
          noteSpan.textContent = "";
          noteSpan.dataset.metaType = "note";

          const noteBtn = document.createElement("button");
          noteBtn.type = "button";
          noteBtn.className = "secondary";
          noteBtn.style.fontSize = "0.65rem";
          noteBtn.textContent = "Add note";
          noteBtn.addEventListener("click", () => {
            const note = prompt("Note for this question:", mechCurrentAnswers[q.id].note || "");
            if (note !== null) {
              mechCurrentAnswers[q.id].note = note.trim();
              noteSpan.textContent = note ? "Note: " + note : "";
            }
          });

          meta.appendChild(ansSpan);
          meta.appendChild(noteSpan);
          meta.appendChild(noteBtn);
          block.appendChild(meta);

          container.appendChild(block);
        });
    });

    hookKeyboardEnterToBlur();
  }

  function mechSelectAnswer(questionId, answer, block, clickedBtn) {
    mechCurrentAnswers[questionId].answer = answer;
    const btns = block.querySelectorAll(".answer-btn");
    btns.forEach(btn => {
      btn.classList.remove("selected", "yes", "no", "na");
      if (btn === clickedBtn) {
        btn.classList.add("selected", answer);
      }
    });
    const metaAns = block.querySelector(".question-meta span[data-meta-type='answer']");
    if (metaAns) {
      metaAns.textContent = "Answer: " + answer.toUpperCase();
    }
  }

  function mechRenderActiveSession() {
    const pill = document.getElementById("mechActiveStatusPill");
    const badges = document.getElementById("mechTimerBadges");
    badges.innerHTML = "";

    if (!mechCurrentSession) {
      pill.textContent = "No active unit";
      pill.className = "pill accent";
      return;
    }

    const statusLabel = mechCurrentSession.status === "in_progress" ? "In progress" :
                        mechCurrentSession.status === "paused" ? "Paused" :
                        mechCurrentSession.status;
    pill.textContent = `${mechCurrentSession.unitName} · ${statusLabel}`;
    pill.className = "pill accent";

    const b1 = document.createElement("span");
    b1.className = "pill";
    b1.textContent = `Engineer (demo): ${mechCurrentSession.engineerName}`;
    badges.appendChild(b1);

    const b2 = document.createElement("span");
    b2.className = "pill";
    b2.textContent = `Period: ${mechCurrentSession.period}, Year: ${mechCurrentSession.year}`;
    badges.appendChild(b2);
  }

  function mechRenderTimer() {
    const display = document.getElementById("mechTimerDisplay");
    if (!mechCurrentSession) {
      display.textContent = "00:00";
      return;
    }
    let base = mechCurrentSession.totalSeconds || 0;
    if (mechCurrentSession.status === "in_progress" && mechTimerStart != null) {
      const elapsed = (Date.now() - mechTimerStart) / 1000;
      base += elapsed;
    }
    display.textContent = formatSeconds(base);
  }

  function mechStartTimer() {
    if (mechTimerInterval) clearInterval(mechTimerInterval);
    mechTimerStart = Date.now();
    mechTimerInterval = setInterval(mechRenderTimer, 1000);
  }

  function mechPauseTimer() {
    if (!mechCurrentSession || mechCurrentSession.status !== "in_progress") return;
    const elapsed = (Date.now() - mechTimerStart) / 1000;
    mechCurrentSession.totalSeconds = (mechCurrentSession.totalSeconds || 0) + elapsed;
    mechTimerStart = null;
    mechCurrentSession.status = "paused";
    if (mechTimerInterval) clearInterval(mechTimerInterval);
    mechRenderTimer();
    mechRenderActiveSession();
    renderMechUnits();
  }

  function mechStopTimerAndComplete() {
    if (!mechCurrentSession) return;
    if (mechCurrentSession.status === "in_progress" && mechTimerStart != null) {
      const elapsed = (Date.now() - mechTimerStart) / 1000;
      mechCurrentSession.totalSeconds = (mechCurrentSession.totalSeconds || 0) + elapsed;
    }
    mechTimerStart = null;
    if (mechTimerInterval) clearInterval(mechTimerInterval);
    mechTimerInterval = null;
    mechRenderTimer();
  }

  function mechClearActiveSessionState() {
    mechCurrentSession = null;
    mechTimerStart = null;
    if (mechTimerInterval) clearInterval(mechTimerInterval);
    mechTimerInterval = null;
    mechRenderTimer();
    mechRenderActiveSession();
    document.getElementById("mechUnitSelect").value = "";
    document.getElementById("mechOverallNotes").value = "";
    mechResetAnswers();
    mechRenderChecklist();
    mechUpdateButtons();
    updateMechLastPmInfo("");
    renderMechUnits();
  }

  function mechUpdateButtons() {
    const startBtn = document.getElementById("mechStartBtn");
    const pauseBtn = document.getElementById("mechPauseBtn");
    const resumeBtn = document.getElementById("mechResumeBtn");
    const completeBtn = document.getElementById("mechCompleteBtn");
    const cancelBtn = document.getElementById("mechCancelBtn");
    const completeBottom = document.getElementById("mechCompleteBtnBottom");

    if (!mechCurrentSession) {
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
      completeBtn.disabled = true;
      cancelBtn.disabled = true;
      completeBottom.disabled = true;
      return;
    }

    if (mechCurrentSession.status === "in_progress") {
      startBtn.disabled = true;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      completeBtn.disabled = false;
      cancelBtn.disabled = false;
      completeBottom.disabled = false;
    } else if (mechCurrentSession.status === "paused") {
      startBtn.disabled = true;
      pauseBtn.disabled = true;
      resumeBtn.disabled = false;
      completeBtn.disabled = false;
      cancelBtn.disabled = false;
      completeBottom.disabled = false;
    } else {
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
      completeBtn.disabled = true;
      cancelBtn.disabled = true;
      completeBottom.disabled = true;
    }
  }

  function mechAllQuestionsAnswered() {
    return mechQuestions.every(q => {
      const ans = mechCurrentAnswers[q.id];
      return ans && ans.answer;
    });
  }

  function updateMechLastPmInfo(unitId) {
    const infoDiv = document.getElementById("mechLastPmInfo");
    if (!unitId) {
      infoDiv.textContent =
        "Select a unit above to view when it was last done, by who, and the score (demo).";
      return;
    }
    const last = getMechLastCompletedSessionForUnit(unitId);
    const unit = mechUnits.find(u => u.id === unitId);
    const name = unit ? unit.name : unitId;
    if (!last) {
      infoDiv.textContent =
        name + " has never been completed in this demo data.";
      return;
    }
    const tStr = last.endedAt || last.startedAt;
    let dateStr = "Unknown date";
    if (tStr) {
      dateStr = new Date(tStr).toLocaleString("en-CA", { timeZone: "America/Toronto" });
    }
    const scoreText = last.review
      ? last.review.score + "% (" + (last.review.pass ? "PASS" : "FAIL") + ")"
      : "Not inspected yet";
    infoDiv.textContent =
      "Last mechanical PM: " + dateStr +
      " · Engineer: " + last.engineerName +
      " · Score: " + scoreText;
  }

  // --- Mode switch (RPM / PM) ---

  function switchMode(mode) {
    currentMode = mode;
    document.querySelectorAll(".mode-btn").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.mode === mode);
    });

    const rpmSection = document.getElementById("rpmSection");
    const mechSection = document.getElementById("mechSection");

    if (mode === "RPM") {
      rpmSection.style.display = "block";
      mechSection.style.display = "none";
    } else {
      rpmSection.style.display = "none";
      mechSection.style.display = "block";
    }
  }

  // --- Events ---

  function attachEvents() {
    // Mode buttons
    document.querySelectorAll(".mode-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const mode = btn.dataset.mode || "RPM";
        switchMode(mode);
      });
    });

    document.getElementById("yearSelect").addEventListener("change", () => {
      renderPeriodProgress();
      renderRoomMap();
    });
    document.getElementById("periodSelect").addEventListener("change", () => {
      renderPeriodProgress();
      renderRoomMap();
    });

    // RPM sort buttons
    document.querySelectorAll(".sort-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        roomSortMode = btn.dataset.sort || "furthest";
        document.querySelectorAll(".sort-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        renderRoomMap();
      });
    });

    const roomInput = document.getElementById("roomInput");
    roomInput.addEventListener("change", () => {
      updateLastPmInfo(roomInput.value.trim());
    });
    roomInput.addEventListener("blur", () => {
      updateLastPmInfo(roomInput.value.trim());
    });

    document.getElementById("startBtn").addEventListener("click", () => {
      const room = document.getElementById("roomInput").value.trim();
      if (!room) {
        alert("Enter a room number to start the RPM (demo).");
        return;
      }
      if (currentSession &&
          (currentSession.status === "in_progress" || currentSession.status === "paused")) {
        const ok = confirm("There is already an active/paused RPM. This demo will cancel it and start a new one. Continue?");
        if (!ok) return;
      }
      const now = new Date();
      currentSession = {
        id: nextSessionId++,
        roomNumber: room,
        engineerCode: currentUser.code,
        engineerName: currentUser.name,
        year: 2025,
        period: Number(document.getElementById("periodSelect").value) || 1,
        status: "in_progress",
        startedAt: now.toISOString(),
        endedAt: null,
        totalSeconds: 0,
        overallNotes: "",
        answers: []
      };
      resetCurrentAnswers();
      renderChecklist();
      renderActiveSession();
      renderRoomMap();
      updateButtonsForStatus();
      startTimer();
      updateLastPmInfo(room);
    });

    document.getElementById("pauseBtn").addEventListener("click", () => {
      pauseTimer();
      updateButtonsForStatus();
      renderRoomMap();
    });

    document.getElementById("resumeBtn").addEventListener("click", () => {
      if (!currentSession) return;
      currentSession.status = "in_progress";
      startTimer();
      updateButtonsForStatus();
      renderActiveSession();
      renderRoomMap();
    });

    function completeFlow() {
      if (!currentSession) {
        alert("No active RPM to complete (demo).");
        return;
      }
      if (!allQuestionsAnswered()) {
        alert("Please answer all questions before completing this RPM (demo).");
        return;
      }
      stopTimerAndComplete();
      currentSession.status = "completed";
      currentSession.endedAt = new Date().toISOString();
      currentSession.overallNotes = document.getElementById("overallNotes").value.trim();
      currentSession.answers = questions.map(q => ({
        questionId: q.id,
        answer: currentAnswers[q.id].answer,
        note: currentAnswers[q.id].note || ""
      }));
      sessions.push(currentSession);
      renderSessionsTable();
      renderSummary();
      renderPeriodProgress();
      renderRoomMap();
      clearActiveSessionState();
    }

    document.getElementById("completeBtn").addEventListener("click", completeFlow);
    document.getElementById("completeBtnBottom").addEventListener("click", completeFlow);

    document.getElementById("cancelBtn").addEventListener("click", () => {
      if (!currentSession) return;
      const ok = confirm("Cancel this RPM? (Demo only – this just clears the active session.)");
      if (!ok) return;
      clearActiveSessionState();
    });

    document.querySelectorAll(".admin-tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        adminActiveTab = btn.dataset.tab;
        renderAdminPanel();
      });
    });

    // Mechanical selectors
    const mechYearSel = document.getElementById("mechYearSelect");
    const mechPeriodSel = document.getElementById("mechPeriodSelect");
    mechYearSel.addEventListener("change", () => {
      renderMechPeriodProgress();
      renderMechUnits();
    });
    mechPeriodSel.addEventListener("change", () => {
      renderMechPeriodProgress();
      renderMechUnits();
    });

    // Mechanical unit select
    const mechUnitSelect = document.getElementById("mechUnitSelect");
    mechUnitSelect.addEventListener("change", () => {
      updateMechLastPmInfo(mechUnitSelect.value);
    });
    mechUnitSelect.addEventListener("blur", () => {
      updateMechLastPmInfo(mechUnitSelect.value);
    });

    // Mechanical start/pause/resume/complete/cancel
    document.getElementById("mechStartBtn").addEventListener("click", () => {
      const unitId = mechUnitSelect.value;
      if (!unitId) {
        alert("Select a mechanical unit to start the PM (demo).");
        return;
      }
      if (mechCurrentSession &&
          (mechCurrentSession.status === "in_progress" || mechCurrentSession.status === "paused")) {
        const ok = confirm("There is already an active/paused mechanical PM. This demo will cancel it and start a new one. Continue?");
        if (!ok) return;
      }

      const unit = mechUnits.find(u => u.id === unitId);
      const now = new Date();
      mechCurrentSession = {
        id: nextMechSessionId++,
        unitId,
        unitName: unit ? unit.name : unitId,
        engineerCode: currentUser.code,
        engineerName: currentUser.name,
        year: 2025,
        period: Number(mechPeriodSel.value) || 1,
        status: "in_progress",
        startedAt: now.toISOString(),
        endedAt: null,
        totalSeconds: 0,
        overallNotes: "",
        answers: [],
        review: null
      };
      mechResetAnswers();
      mechRenderChecklist();
      mechRenderActiveSession();
      mechUpdateButtons();
      mechStartTimer();
      updateMechLastPmInfo(unitId);
      renderMechUnits();
    });

    document.getElementById("mechPauseBtn").addEventListener("click", () => {
      mechPauseTimer();
      mechUpdateButtons();
    });

    document.getElementById("mechResumeBtn").addEventListener("click", () => {
      if (!mechCurrentSession) return;
      mechCurrentSession.status = "in_progress";
      mechStartTimer();
      mechUpdateButtons();
      mechRenderActiveSession();
      renderMechUnits();
    });

    function mechCompleteFlow() {
      if (!mechCurrentSession) {
        alert("No active mechanical PM to complete (demo).");
        return;
      }
      if (!mechAllQuestionsAnswered()) {
        alert("Please answer all questions before completing this mechanical PM (demo).");
        return;
      }
      mechStopTimerAndComplete();
      mechCurrentSession.status = "closed";
      mechCurrentSession.endedAt = new Date().toISOString();
      mechCurrentSession.overallNotes = document.getElementById("mechOverallNotes").value.trim();
      mechCurrentSession.answers = mechQuestions.map(q => ({
        questionId: q.id,
        answer: mechCurrentAnswers[q.id].answer,
        note: mechCurrentAnswers[q.id].note || ""
      }));

      // Auto-review based on YES/NO
      let passCount = 0;
      let failCount = 0;
      const items = mechQuestions.map(q => {
        const ansObj = mechCurrentAnswers[q.id];
        let status;
        if (!ansObj || ansObj.answer === "na") status = "na";
        else if (ansObj.answer === "yes") status = "pass";
        else status = "fail";
        if (status === "pass") passCount++;
        else if (status === "fail") failCount++;
        return { questionId: q.id, status, note: "" };
      });
      const denom = passCount + failCount;
      const score = denom ? Math.round((passCount / denom) * 100) : 0;
      const passBool = score >= 80;

      mechCurrentSession.review = {
        reviewerName: currentUser.name,
        score,
        pass: passBool,
        notes: passBool ? "Auto-reviewed: looks good." : "Auto-reviewed: check issues.",
        items
      };

      mechSessions.push(mechCurrentSession);
      renderMechSessionsTable();
      renderMechSummary();
      renderMechPeriodProgress();
      renderMechUnits();
      renderMechRanking();
      mechClearActiveSessionState();
    }

    document.getElementById("mechCompleteBtn").addEventListener("click", mechCompleteFlow);
    document.getElementById("mechCompleteBtnBottom").addEventListener("click", mechCompleteFlow);

    document.getElementById("mechCancelBtn").addEventListener("click", () => {
      if (!mechCurrentSession) return;
      const ok = confirm("Cancel this mechanical PM? (Demo only – this just clears the active session.)");
      if (!ok) return;
      mechClearActiveSessionState();
    });

    hookKeyboardEnterToBlur();
  }

  // --- Init ---

  function initDemo() {
    // Seed data
    seedDemoSessions();
    resetCurrentAnswers();

    seedMechanicalDemo();
    mechResetAnswers();

    // Fill mechanical unit select
    const mechUnitSelect = document.getElementById("mechUnitSelect");
    mechUnits.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u.id;
      opt.textContent = u.name;
      mechUnitSelect.appendChild(opt);
    });

    // RPM initial render
    renderChecklist();
    renderPeriodProgress();
    renderSummary();
    renderRoomMap();
    renderActiveSession();
    renderTimer();
    renderSessionsTable();
    renderRanking();
    renderAdminPanel();

    // Mechanical initial render
    renderMechPeriodProgress();
    renderMechSummary();
    renderMechUnits();
    renderMechSessionsTable();
    renderMechRanking();
    mechRenderChecklist();
    mechRenderActiveSession();
    mechRenderTimer();

    attachEvents();
    switchMode("RPM"); // start with RPM visible
  }

  document.addEventListener("DOMContentLoaded", initDemo);
</script>
</body>
</html>
